name: Continuous Integration

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files --show-diff-on-failure

  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      has-code: ${{ steps.changes.outputs.code }}
      has-docs: ${{ steps.changes.outputs.docs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - '**/*.py'
              - '**/*.js'
              - '**/*.ts'
              - '**/*.java'
              - '**/*.go'
              - '**/*.rs'
              - '**/*.cpp'
              - '**/*.c'
              - '**/*.cs'
              - '**/*.php'
              - '**/*.rb'
              - '**/*.swift'
              - '**/*.kt'
              - '**/package*.json'
              - '**/requirements*.txt'
              - '**/Cargo.toml'
              - '**/go.mod'
              - '**/pom.xml'
              - '**/build.gradle*'
              - '**/Gemfile'
              - '**/composer.json'
            docs:
              - '**/*.md'
              - '**/docs/**'

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    strategy:
      matrix:
        language: ['python', 'node', 'go', 'java']
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Setup Node.js
        if: matrix.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Go
        if: matrix.language == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Java
        if: matrix.language == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run Python tests
        if: matrix.language == 'python' && hashFiles('**/requirements*.txt', '**/setup.py', '**/pyproject.toml') != ''
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          python -m pytest --cov --cov-report=xml || echo "No tests found"

      - name: Run Node.js tests
        if: matrix.language == 'node' && hashFiles('**/package*.json') != ''
        run: |
          npm ci
          npm test || echo "No tests found"

      - name: Run Go tests
        if: matrix.language == 'go' && hashFiles('**/go.mod') != ''
        run: |
          go test -v -coverprofile=coverage.out ./... || echo "No tests found"

      - name: Run Java tests
        if: matrix.language == 'java' && (hashFiles('**/pom.xml') != '' || hashFiles('**/build.gradle*') != '')
        run: |
          if [ -f pom.xml ]; then mvn test; fi
          if [ -f build.gradle ] || [ -f build.gradle.kts ]; then ./gradlew test; fi
          echo "Tests completed or no tests found"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
        if: always()

  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-docs == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Lint Markdown
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: '**/*.md'

      - name: Check links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.github/configs/markdown-link-check.json'
